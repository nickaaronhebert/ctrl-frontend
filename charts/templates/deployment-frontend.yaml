apiVersion: apps/v1
kind: Deployment
metadata:
    name: {{ .Values.frontendService.name }}-dep
    labels:
        chart: '{{ template "name" . }}-{{ .Chart.Version | replace "+" "_" }}'
spec:
    replicas: {{ .Values.replicaCount }}
    strategy:
        type: RollingUpdate
        rollingUpdate:
            maxSurge: 1
            maxUnavailable: 0%
    selector:
        matchLabels:
            app.kubernetes.io/name: app-{{ .Values.frontendService.name }}
    template:
        metadata:
            labels:
                app.kubernetes.io/name: app-{{ .Values.frontendService.name }}
                kind: ctrl-frontend
        spec:
            nodeSelector:
              {{ .Values.nodeSelector }}
            containers:
                -   name: {{ .Values.frontendService.name }}
                    image: "{{ .Values.repo }}/{{ .Values.frontendService.imageName }}:{{ .Values.imageTag }}"
                    imagePullPolicy: Always
                    envFrom:
                        -   configMapRef:
                                name: {{ .Values.frontendService.name }}-config
                    ports:
                        - containerPort: {{ .Values.frontendService.internalPort }}
                    resources:
{{ toYaml .Values.frontendService.resources | indent 24 }}
                  # Liveness probe (restart container if unhealthy)
                    livenessProbe:
                      httpGet:
                        path: {{ default "/" .Values.frontendService.livenessProbe.path }}
                        port: {{ .Values.frontendService.internalPort }}
                      initialDelaySeconds: {{ default 30 .Values.frontendService.livenessProbe.initialDelaySeconds }}
                      periodSeconds: {{ default 10 .Values.frontendService.livenessProbe.periodSeconds }}
                      timeoutSeconds: {{ default 5 .Values.frontendService.livenessProbe.timeoutSeconds }}
                      failureThreshold: {{ default 3 .Values.frontendService.livenessProbe.failureThreshold }}
                  # Readiness probe (controls traffic routing)
                    readinessProbe:
                      httpGet:
                        path: {{ default "/" .Values.frontendService.readinessProbe.path }}
                        port: {{ .Values.frontendService.internalPort }}
                      initialDelaySeconds: {{ default 5 .Values.frontendService.readinessProbe.initialDelaySeconds }}
                      periodSeconds: {{ default 10 .Values.frontendService.readinessProbe.periodSeconds }}
                      timeoutSeconds: {{ default 3 .Values.frontendService.readinessProbe.timeoutSeconds }}
                      failureThreshold: {{ default 3 .Values.frontendService.readinessProbe.failureThreshold }}
                  # Optional startup probe to give app more time to initialize
                    startupProbe:
                      httpGet:
                        path: {{ default "/" .Values.frontendService.startupProbe.path }}
                        port: {{ .Values.frontendService.internalPort }}
                      initialDelaySeconds: {{ default 10 .Values.frontendService.startupProbe.initialDelaySeconds }}
                      periodSeconds: {{ default 10 .Values.frontendService.startupProbe.periodSeconds }}
